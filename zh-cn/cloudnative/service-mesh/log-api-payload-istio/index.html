<!DOCTYPE html>
<html lang="zh-cn">
<head>
  
    <title>Istio 中监视 API 调用报文 :: Mark Zhu&#39;s Blog — Keep coding</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="概述 API Payload capture is a key tool for troubleshooting.
Tcpdump is the tool working at ISO layer 3~6, Many modern API working at Layer 7(HTTP), many capture rules are working only on Layer 7. E.g. filter payload by URL Path is hard for tcpdump:
tcpdump -i enp0s8 -s 0 -v -n -l | egrep -i &amp;#34;POST /|GET /|Host:&amp;#34; Old school: tcpdump on minikube(FT) or Node local Below is an example of tcpdump." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/zh-cn/cloudnative/service-mesh/log-api-payload-istio/" />




<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/blue.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />

  <meta name="twitter:site" content="" />

<meta name="twitter:creator" content="" />


<meta property="og:locale" content="zh-cn" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Istio 中监视 API 调用报文 :: Mark Zhu&#39;s Blog">
<meta property="og:description" content="概述 API Payload capture is a key tool for troubleshooting.
Tcpdump is the tool working at ISO layer 3~6, Many modern API working at Layer 7(HTTP), many capture rules are working only on Layer 7. E.g. filter payload by URL Path is hard for tcpdump:
tcpdump -i enp0s8 -s 0 -v -n -l | egrep -i &amp;#34;POST /|GET /|Host:&amp;#34; Old school: tcpdump on minikube(FT) or Node local Below is an example of tcpdump." />
<meta property="og:url" content="/zh-cn/cloudnative/service-mesh/log-api-payload-istio/" />
<meta property="og:site_name" content="Istio 中监视 API 调用报文" />

  
    <meta property="og:image" content="/img/favicon/blue.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2020-04-11 17:42:57 &#43;0800 CST" />












</head>
<body class="">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    主页
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/cloudnative">Cloud Native</a></li>
        
      
        
          <li><a href="/about">关于我</a></li>
        
      
      
    

    
    <div class="spacer"></div>
    <ul class="language-selector">
      <ul class="language-selector-current">
          <li>中文 ▾</li>
      </ul>
      <ul class="language-selector__more hidden">
        
        <li><a href="/">English</a></li>
        
        <li><a href="/zh-cn/">中文</a></li>
        
      </ul>
    </ul>
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/cloudnative">Cloud Native</a></li>
      
    
      
        <li><a href="/about">关于我</a></li>
      
    
    
    <hr />
        
          <li>
            <a href="/">English</a>
          </li>
        
          <li>
            <a href="/zh-cn/">中文</a>
          </li>
        
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/zh-cn/cloudnative/service-mesh/log-api-payload-istio/">Istio 中监视 API 调用报文</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2020-04-11
    </span>
    
    
  </div>

  

  

  <aside>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#old-school-tcpdump-on-minikubeft-or-node-local">Old school: tcpdump on minikube(FT) or Node local</a></li>
    <li><a href="#sidecarenvoy-filtertap">Sidecar(Envoy) Filter/Tap</a>
      <ul>
        <li><a href="#setup">Setup</a></li>
        <li><a href="#capture">Capture</a></li>
        <li><a href="#how-it-work">How it work</a></li>
        <li><a href="#how-to-customize">How to customize</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>  

  <div class="post-content"><div>
        <h2 id="概述">概述<a href="#概述" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>API Payload capture is a key tool for troubleshooting.</p>
<p>Tcpdump is the tool working at ISO layer 3~6, Many modern API working at Layer 7(HTTP), many capture rules are working only on Layer 7.
E.g. filter payload by URL Path is hard for tcpdump:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tcpdump -i enp0s8 -s <span style="color:#ae81ff">0</span> -v -n -l | egrep -i <span style="color:#e6db74">&#34;POST /|GET /|Host:&#34;</span>
</code></pre></div><h2 id="old-school-tcpdump-on-minikubeft-or-node-local">Old school: tcpdump on minikube(FT) or Node local<a href="#old-school-tcpdump-on-minikubeft-or-node-local" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Below is an example of tcpdump.</p>
<pre><code>[root@host-os ~]# ps -ef | grep -i myServicePS
100       398212  398058  0 Apr07 ?        00:26:08 java ...myServicePS...

set CONTAINER_PID_AT_HOST=398212

[root@host-os ~]# nsenter -t $CONTAINER_PID_AT_HOST  -u -i -n -p -C tcpdump -A -vv
...
</code></pre><p>In many cases, it is hard to find your API in the network flood from tcpdump.</p>
<h2 id="sidecarenvoy-filtertap">Sidecar(Envoy) Filter/Tap<a href="#sidecarenvoy-filtertap" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In Istio(Service Mesh), Envoy is the sidecar. All API traffic proxy by it. It supports HTTP Filters, we can create some filter on Envoy to capture payload.</p>
<p>Tow methods are support:</p>
<ul>
<li>Tap Fitler</li>
<li>Lua Filter</li>
</ul>
<h3 id="setup">Setup<a href="#setup" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://mark.mygraphql.com/log-api-payload-istio/istio-envoy-log-filter.yaml

<span style="color:#75715e">#Optional: check k8s resource:</span> 
kubectl describe envoyfilters.networking.istio.io logpayload
<span style="color:#75715e">#Optional: check envoy configuartion updated:</span> 
kubectl port-forward productpage-v1-85b9bf9cd7-gk6gk 15000:15000
curl localhost:15000/config_dump 
</code></pre></div><p><a href="/log-api-payload-istio/istio-envoy-log-filter.yaml">Download: istio-envoy-log-filter.yaml</a></p>
<h3 id="capture">Capture<a href="#capture" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="method-1-capture-by-tap-fitler">Method 1: Capture by Tap Fitler<a href="#method-1-capture-by-tap-fitler" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<pre><code>kubectl port-forward productpage-v1-85b9bf9cd7-gk6gk 15000:15000

# Curl long poll
curl -XPOST -d 'config_id: test_config_id
tap_config:
  match_config:
    any_match: true
  output_config:
    sinks:
      - format: JSON_BODY_AS_STRING
        streaming_admin: {}
    max_buffered_rx_bytes: 2097152      
    max_buffered_tx_bytes: 2097152' 'http://localhost:15000/tap'


# Open another terminal:
curl http://192.168.56.11:80/productpage
</code></pre><h4 id="method-2-by-kubectl-logs">Method 2: By kubectl logs<a href="#method-2-by-kubectl-logs" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<pre><code>kubectl logs -f your-pod -c istio-proxy

# Open another terminal:
curl http://192.168.56.11:80/productpage
</code></pre><h3 id="how-it-work">How it work<a href="#how-it-work" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: EnvoyFilter
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: logpayload
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">workloadSelector</span>:
    <span style="color:#66d9ef">labels</span>:
      <span style="color:#66d9ef">app</span>: productpage
  <span style="color:#66d9ef">configPatches</span>:
    <span style="color:#75715e"># The first patch adds the lua filter to the listener/http connection manager</span>
  - <span style="color:#66d9ef">applyTo</span>: HTTP_FILTER
    <span style="color:#66d9ef">match</span>:
      <span style="color:#66d9ef">context</span>: SIDECAR_INBOUND
      <span style="color:#66d9ef">listener</span>:
<span style="color:#75715e">#        portNumber: 15001</span>
        <span style="color:#66d9ef">filterChain</span>:
          <span style="color:#66d9ef">filter</span>:
            <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.http_connection_manager&#34;</span>
            <span style="color:#66d9ef">subFilter</span>:
              <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.router&#34;</span>
    <span style="color:#66d9ef">patch</span>:
      <span style="color:#66d9ef">operation</span>: INSERT_BEFORE
      <span style="color:#66d9ef">value</span>: <span style="color:#75715e"># filter specification</span>
        <span style="color:#75715e"># name: envoy.filters.http.tap</span>
        <span style="color:#75715e">#   config:</span>
        <span style="color:#75715e">#     common_config:</span>
        <span style="color:#75715e">#       static_config:</span>
        <span style="color:#75715e">#         match_config:</span>
        <span style="color:#75715e">#           any_match: true</span>
        <span style="color:#75715e">#         output_config:</span>
        <span style="color:#75715e">#           sinks:</span>
        <span style="color:#75715e">#             - file_per_tap:</span>
        <span style="color:#75715e">#                 path_prefix: taps/any</span>

        <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.filters.http.tap&#34;</span>
        <span style="color:#66d9ef">config</span>:
          <span style="color:#66d9ef">common_config</span>:
            <span style="color:#66d9ef">admin_config</span>:
              <span style="color:#66d9ef">config_id</span>: test_config_id

  - <span style="color:#66d9ef">applyTo</span>: HTTP_FILTER
    <span style="color:#66d9ef">match</span>:
      <span style="color:#66d9ef">context</span>: SIDECAR_INBOUND
      <span style="color:#66d9ef">listener</span>:
<span style="color:#75715e">#        portNumber: 15001</span>
        <span style="color:#66d9ef">filterChain</span>:
          <span style="color:#66d9ef">filter</span>:
            <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.http_connection_manager&#34;</span>
            <span style="color:#66d9ef">subFilter</span>:
              <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.router&#34;</span>
    <span style="color:#66d9ef">patch</span>:
      <span style="color:#66d9ef">operation</span>: INSERT_BEFORE
      <span style="color:#66d9ef">value</span>: <span style="color:#75715e"># filter specification</span>
          <span style="color:#66d9ef">name</span>: envoy.lua
          <span style="color:#66d9ef">typed_config</span>:
            <span style="color:#66d9ef">&#34;@type&#34;: </span>type.googleapis.com/envoy.config.filter.http.lua.v2.Lua
            <span style="color:#66d9ef">inline_code</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">              function logPayload(handle)</span>
                  handle:logWarn(<span style="color:#e6db74">&#34;[logPayload] started&#34;</span>)

                  local index = <span style="color:#ae81ff">0</span>
                  for chunk in handle:bodyChunks() do
                      handle:logWarn(<span style="color:#e6db74">&#39;[logPayload] showing bodyChunks&#39;</span>)

                      local len = chunk:length()
                      if len &lt; <span style="color:#ae81ff">1</span> then
                        break
                      end
                      local result = chunk:getBytes(index, len)
                      index = index + len

                      handle:logWarn(result)
                  end

                  handle:logWarn(<span style="color:#e6db74">&#34;[logPayload] finished&#34;</span>)
              end            

              function envoy_on_request(handle)
                logPayload(handle)
              end
              function envoy_on_response(handle)
                logPayload(handle)
              end   
</code></pre></div><h3 id="how-to-customize">How to customize<a href="#how-to-customize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="filter-by-servie">filter by servie<a href="#filter-by-servie" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h4 id="filter-by-url">filter by URL<a href="#filter-by-url" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

      </div></div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
